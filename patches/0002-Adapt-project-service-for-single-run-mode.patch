From 70e5921f3e00d1fb3e968fc8dc5b9db1f01160b0 Mon Sep 17 00:00:00 2001
From: auvred <aauvred@gmail.com>
Date: Wed, 6 Aug 2025 11:39:11 +0000
Subject: [PATCH 2/4] Adapt project service for single run mode

---
 internal/project/checkerpool.go | 9 +++++++++
 internal/project/project.go     | 3 ++-
 2 files changed, 11 insertions(+), 1 deletion(-)

diff --git a/internal/project/checkerpool.go b/internal/project/checkerpool.go
index 6bcbcc686..27dff946d 100644
--- a/internal/project/checkerpool.go
+++ b/internal/project/checkerpool.go
@@ -94,6 +94,15 @@ func (p *checkerPool) GetAllCheckers(ctx context.Context) ([]*checker.Checker, f
 	if requestID == "" {
 		panic("cannot call GetAllCheckers on a project.checkerPool without a request ID")
 	}
+	if requestID == "__single_run__" {
+		for i, existing := range p.checkers {
+			if existing == nil {
+				checker := checker.NewChecker(p.program)
+				p.checkers[i] = checker
+			}
+		}
+		return p.checkers, noop
+	}
 
 	// A request can only access one checker
 	if c, release := p.getRequestCheckerLocked(requestID); c != nil {
diff --git a/internal/project/project.go b/internal/project/project.go
index 17689ce50..f2ee08235 100644
--- a/internal/project/project.go
+++ b/internal/project/project.go
@@ -2,6 +2,7 @@ package project
 
 import (
 	"fmt"
+	"runtime"
 	"strings"
 	"sync"
 
@@ -311,7 +312,7 @@ func (p *Project) CreateProgram() CreateProgramResult {
 				TypingsLocation:             typingsLocation,
 				JSDocParsingMode:            ast.JSDocParsingModeParseAll,
 				CreateCheckerPool: func(program *compiler.Program) compiler.CheckerPool {
-					checkerPool = newCheckerPool(4, program, p.log)
+					checkerPool = newCheckerPool(runtime.GOMAXPROCS(0), program, p.log)
 					return checkerPool
 				},
 			},
-- 
2.39.5 (Apple Git-154)

