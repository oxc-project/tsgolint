From 51d6dc9aaa97e8a85bdbc0868beb86cbf70eccf3 Mon Sep 17 00:00:00 2001
From: Cameron Clark <cameron.clark@hey.com>
Date: Fri, 14 Nov 2025 11:09:52 +0000
Subject: [PATCH] Adapt project service for single run mode

---
 internal/project/checkerpool.go | 10 ++++++++++
 internal/project/project.go     |  3 ++-
 2 files changed, 12 insertions(+), 1 deletion(-)

diff --git a/internal/project/checkerpool.go b/internal/project/checkerpool.go
index a83a2e833..4612d6064 100644
--- a/internal/project/checkerpool.go
+++ b/internal/project/checkerpool.go
@@ -106,6 +106,16 @@ func (p *CheckerPool) ForEachCheckerParallel(ctx context.Context, cb func(idx in
 	if requestID == "" {
 		panic("cannot call ForEachCheckerParallel on a project.checkerPool without a request ID")
 	}
+	if requestID == "__single_run__" {
+		for i, existing := range p.checkers {
+			if existing == nil {
+				checker := checker.NewChecker(p.program)
+				p.checkers[i] = checker
+			}
+			cb(i, p.checkers[i])
+		}
+		return
+	}
 
 	// A request can only access one checker
 	if c, release := p.getRequestCheckerLocked(requestID); c != nil {
diff --git a/internal/project/project.go b/internal/project/project.go
index 77a99abf0..3fb881542 100644
--- a/internal/project/project.go
+++ b/internal/project/project.go
@@ -2,6 +2,7 @@ package project
 
 import (
 	"fmt"
+	"runtime"
 	"strings"
 	"sync"
 
@@ -307,7 +308,7 @@ func (p *Project) CreateProgram() CreateProgramResult {
 				TypingsLocation:             typingsLocation,
 				JSDocParsingMode:            ast.JSDocParsingModeParseAll,
 				CreateCheckerPool: func(program *compiler.Program) compiler.CheckerPool {
-					checkerPool = newCheckerPool(4, program, p.log)
+					checkerPool = newCheckerPool(runtime.GOMAXPROCS(0), program, p.log)
 					return checkerPool
 				},
 			},
-- 
2.50.1 (Apple Git-155)

